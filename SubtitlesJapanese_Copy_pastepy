import os
import re
import sys
import time
import json
import bisect
from typing import List, Optional

import srt
import pyautogui
from pynput.mouse import Button, Listener
from pynput.keyboard import Key, Listener as KeyboardListener
import chardet

import tkinter as tk
from tkinter import filedialog, font as tkFont


class SubtitlePlayer:

    def __init__(self) -> None:


        self.srt_dir = os.path.dirname(self.srt_path)
        self._srt_file_list = [
            f for f in os.listdir(self.srt_dir)
            if f.lower().endswith('.srt')]
        self.subtitles: List[srt.Subtitle] = self.load_subtitles(self.srt_path)
        self.cleaned_subtitles = [self._clean_text(sub.content) for sub in self.subtitles]
        self.total_duration: float = self.get_total_duration()
        self.start_times: List[float] = [sub.start.total_seconds() for sub in self.subtitles]
        self.subtitle_color = config['SUBTITLE_COLOR']

        self.root = tk.Tk()
        self.root.title("Subtitle Player Settings")
        self.root.geometry("330x130")
        self.root.minsize(340, 130)
        self.root.configure(bg="#f0f0f0")
        self.subtitle_font = tkFont.Font(family=config['SUBTITLE_FONT'], size=config['SUBTITLE_FONT_SIZE'], weight="bold")
        self.line_height = self.subtitle_font.metrics("linespace")
        self.max_width = self.measure_max_subtitle_width()

        self.current_time: float = config['DEFAULT_START_TIME']
        self.user_offset: float = 0.0
        self.last_update: float = time.time()
        self.hide_delay: int = config['CONTROL_HIDE_DELAY_MS']
        self.disappear_timer: int = config['CONTROL_DISAPPEAR_DELAY_MS']
        self.last_subtitle_text: str = ""
        self.subtitle_timeout_job: Optional[str] = None
        self.hide_controls_job: Optional[str] = None
        self.control_hide_timer_job: Optional[str] = None
        self.alt_reset_done: bool = False
        self.user_hidden: bool = False
        self.slider_dragging: bool = False
        self.user_hidden: bool = False
        self.mouse_over_controls: bool = False
        self.mouse_over_subtitles: bool = False
        self.playing: bool = False
        self.time_editing: bool = False
        self.video_click: bool = config['VIDEO_CLICK']
        self.use_phone_mode = tk.BooleanVar(value=False)
        self.init_settings_window()
        self.init_subtitle_window()
        self.init_control_window()
        self.bind_mouse_events()
        self.update_phone_mode_ui()
        self.control_window.attributes("-topmost", True)
        self.play_pause_button.config(text="Play", bg="green", font = "bold", activebackground="green")



        # self.root.after(0, self.toggle_play)
        self.root.after(config['UPDATE_INTERVAL_MS'], self.update_loop)
